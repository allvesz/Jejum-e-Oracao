<!doctype html>
<html lang="pt-BR" data-theme="paper">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#f6f1e8" />
  <title>Jejum & Ora√ß√£o</title>
  <style>
    :root{
      --bg: #f6f1e8;
      --surface: #fffaf2;
      --surface2:#f3ece1;
      --ink:#2a2a2a;
      --muted:#6b675f;
      --line:#e9dfd1;
      --stroke:#e6dbc9;
      --accent:#7aa6a6;
      --accent2:#c89fb7;
      --ok:#2f7d53;
      --warn:#9a6b2f;
      --danger:#a13d3d;
      --shadow: 0 10px 30px rgba(30,20,10,.08);
      --radius: 18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* --- TODOS OS TEMAS RESTAURADOS --- */
    html[data-theme="sinai"] { --bg: #eaddca; --surface: #f4ede4; --surface2: #dfd3c3; --accent: #8b5e3c; --ink: #3e2723; --stroke: #cbbba0; --line: #cbbba0; }
    html[data-theme="ceu"] { --bg: #eef5f9; --surface: #ffffff; --surface2: #dbe9f1; --accent: #4a90e2; --ink: #1a2a3a; --stroke: #cedee7; --line: #cedee7; }
    html[data-theme="noite"] { --bg: #1a1a1a; --surface: #262626; --ink: #eee; --stroke: #333; --accent: #85b6b6; --line: #444; --surface2: #333; }
    html[data-theme="videira"] { --bg: #f5eff5; --surface: #ffffff; --surface2: #eadcea; --accent: #8e44ad; --ink: #2c1a32; --stroke: #d4bad4; --line: #d4bad4; }
    html[data-theme="oliveira"] { --bg: #f0f4ef; --surface: #ffffff; --surface2: #dae4d8; --accent: #556b2f; --ink: #252d1c; --stroke: #c5d3c2; --line: #c5d3c2; }

    *{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--sans); color: var(--ink); background: var(--bg); overscroll-behavior-y: contain; transition: background 0.3s; }

    .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }

    .header {
      padding: 30px 20px; text-align: center; background: var(--surface);
      border-bottom: 1px solid var(--stroke); border-radius: 0 0 24px 24px; box-shadow: var(--shadow);
    }
    .header h1 { margin: 0; font-size: 22px; font-weight: 800; color: var(--accent); letter-spacing: -0.02em; }

    .content { padding: 20px 15px 120px; flex: 1; }

    .card {
      background: var(--surface); border-radius: var(--radius); padding: 20px;
      margin-bottom: 20px; border: 1px solid var(--stroke); box-shadow: var(--shadow);
    }

    label { display: block; font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }

    input, select {
      width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid var(--stroke);
      background: var(--surface2); color: var(--ink); font-size: 15px; margin-bottom: 15px; font-family: inherit;
    }

    .btn-main {
      background: var(--accent); color: white; border: none; padding: 16px;
      border-radius: 14px; font-weight: 800; font-size: 15px; width: 100%; cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-main:active { opacity: 0.8; transform: scale(0.98); }

    .btn-outline {
      background: none; border: 2px solid var(--accent); color: var(--accent);
      padding: 12px; border-radius: 12px; font-weight: 700; width: 100%; margin-top: 10px; cursor: pointer;
    }

    .day-row { border-bottom: 1px solid var(--line); padding: 15px 0; }
    .day-title { font-weight: 800; font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .day-num { width: 24px; height: 24px; background: var(--accent); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 11px; }

    .check-container { display: flex; gap: 8px; flex-wrap: wrap; }
    .check-btn {
      padding: 8px 14px; border-radius: 10px; border: 1px solid var(--stroke);
      font-size: 11px; font-weight: 700; background: var(--surface2); color: var(--muted); cursor: pointer;
    }
    .check-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

    .nav-bar {
      position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface);
      display: flex; justify-content: space-around; padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
      border-top: 1px solid var(--stroke); z-index: 100;
    }
    .nav-item { border: none; background: none; color: var(--muted); font-size: 10px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1; }
    .nav-item.active { color: var(--accent); }
    .nav-icon { font-size: 20px; }

    .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 800; display: inline-block; margin-bottom: 10px; }
    .status-on { background: #e6f2ed; color: var(--ok); }
    .status-off { background: #f2e6e6; color: var(--danger); }

    .hide { display: none; }
  </style>
</head>
<body>

<div class="app-container">
  <header class="header">
    <h1 id="txt-app-title">üôè Jejum e Ora√ß√£o</h1>
  </header>

  <main class="content">
    <section id="view-novo">
      <div class="card">
        <label>T√≠tulo do Prop√≥sito</label>
        <input type="text" id="p-tema" placeholder="Ex: Jejum de Daniel">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div><label>In√≠cio</label><input type="date" id="p-inicio"></div>
          <div>
            <label>Dura√ß√£o</label>
            <select id="p-duracao" onchange="toggleDuracaoCustom(this.value)">
              <option value="1">1 Dia</option>
              <option value="3">3 Dias</option>
              <option value="7">7 Dias</option>
              <option value="21">21 Dias</option>
              <option value="40">40 Dias</option>
              <option value="custom">Personalizado</option>
            </select>
            <div id="p-duracao-custom-wrap" class="hide" style="margin-top:-6px;">
              <label style="margin-top:6px;">Quantidade de dias</label>
              <input type="number" id="p-duracao-custom" inputmode="numeric" min="1" step="1" placeholder="Ex: 10">
            </div>
          </div>
        </div>

        <label>Per√≠odo de Jejum Di√°rio</label>
        <select id="p-horas" onchange="toggleHorasCustom(this.value)">
          <option value="12h">12 Horas</option>
          <option value="18h">18 Horas</option>
          <option value="24h">24 Horas</option>
          <option value="custom">Personalizado</option>
        </select>

        <div id="p-horas-custom-wrap" class="hide" style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:-6px; margin-bottom: 15px;">
          <div>
            <label>In√≠cio</label>
            <input type="time" id="p-fast-start" value="06:00">
          </div>
          <div>
            <label>Fim</label>
            <input type="time" id="p-fast-end" value="18:00">
          </div>
        </div>

        <label>Frequ√™ncia</label>
        <select id="p-freq" onchange="document.getElementById('week-sel').classList.toggle('hide', this.value !== 'semanal')">
          <option value="corrido">Dias Corridos</option>
          <option value="semanal">Dias da Semana</option>
        </select>

        <div id="week-sel" class="hide">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px;">
            <button class="check-btn" onclick="this.classList.toggle('active')" data-d="1">Seg</button>
            <button class="check-btn" onclick="this.classList.toggle('active')" data-d="2">Ter</button>
            <button class="check-btn" onclick="this.classList.toggle('active')" data-d="3">Qua</button>
            <button class="check-btn" onclick="this.classList.toggle('active')" data-d="4">Qui</button>
            <button class="check-btn" onclick="this.classList.toggle('active')" data-d="5">Sex</button>
            <button class="check-btn" onclick="this.classList.toggle('active')" data-d="6">S√°b</button>
            <button class="check-btn" onclick="this.classList.toggle('active')" data-d="0">Dom</button>
          </div>
        </div>

        <button class="btn-main" onclick="savePlan()">COME√áAR AGORA</button>
      </div>
    </section>

    <section id="view-lista" class="hide">
      <div id="plans-container"></div>
    </section>

    <section id="view-config" class="hide">
      <div class="card">
        <h3>Ajustes do App</h3>
        <label>Tema</label>
        <select id="cfg-theme" onchange="setTheme(this.value)">
          <option value="paper">Papel (Original)</option>
          <option value="sinai">Monte Sinai</option>
          <option value="ceu">Azul C√©u</option>
          <option value="videira">Videira (Roxo)</option>
          <option value="oliveira">Oliveira (Verde)</option>
          <option value="noite">Modo Noite</option>
        </select>

        <hr style="border:0; border-top: 1px solid var(--stroke); margin: 25px 0;">

        <h3>Lembretes di√°rios</h3>
        <div id="notif-status" class="status-badge status-off">Notifica√ß√µes Desativadas</div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div><label>üåÖ In√≠cio Jejum</label><input type="time" id="rem-f-start" value="06:00"></div>
          <div><label>üåá Entrega Jejum</label><input type="time" id="rem-f-end" value="18:00"></div>
          <div><label>üôè Ora√ß√£o Manh√£</label><input type="time" id="rem-p-start" value="07:00"></div>
          <div><label>üåô Ora√ß√£o Noite</label><input type="time" id="rem-p-end" value="21:00"></div>
        </div>

        <h3 style="margin-top:22px;">Lembretes personalizados</h3>
        <div id="custom-reminders"></div>
        <button class="btn-outline" onclick="addCustomReminder()" type="button">+ ADICIONAR LEMBRETE</button>

        <div style="font-size:11px; color:var(--muted); margin-top:10px; line-height:1.35;">
          Dica: estes lembretes ser√£o disparados todos os dias no hor√°rio escolhido.
        </div>

        <button class="btn-main" id="btn-enable-notif">ATIVAR NOTIFICA√á√ïES</button>
        <button class="btn-outline" id="btn-disable-notif" style="border-color: var(--danger); color: var(--danger);">DESATIVAR</button>
      </div>
    </section>

    <section id="view-detalhe" class="hide">
      <div id="detail-content"></div>
    </section>
  </main>

  <nav class="nav-bar">
    <button class="nav-item active" onclick="showView('novo')" id="nav-novo">
      <span class="nav-icon">‚ú®</span><span>Novo</span>
    </button>
    <button class="nav-item" onclick="showView('lista')" id="nav-lista">
      <span class="nav-icon">üìñ</span><span>Di√°rio</span>
    </button>
    <button class="nav-item" onclick="showView('config')" id="nav-config">
      <span class="nav-icon">‚öôÔ∏è</span><span>Ajustes</span>
    </button>
  </nav>
</div>

<script>
  // --- INICIALIZA√á√ÉO DE DADOS ---
  let db = JSON.parse(localStorage.getItem('faith_v3_db')) || { plans: [], config: { theme: 'paper', customReminders: [] } };

  function saveDB() { localStorage.setItem('faith_v3_db', JSON.stringify(db)); }

  function showView(id) {
    document.querySelectorAll('section').forEach(s => s.classList.add('hide'));
    document.getElementById('view-' + id).classList.remove('hide');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('nav-' + (id === 'detalhe' ? 'lista' : id)).classList.add('active');
    if(id === 'lista') renderPlans();
  }

  function toggleDuracaoCustom(val) {
    document.getElementById('p-duracao-custom-wrap').classList.toggle('hide', val !== 'custom');
    if (val !== 'custom') document.getElementById('p-duracao-custom').value = '';
  }

  function toggleHorasCustom(val) {
    document.getElementById('p-horas-custom-wrap').classList.toggle('hide', val !== 'custom');
  }

  // --- LEMBRETES PERSONALIZADOS ---
  function ensureCustomReminders() {
    if (!db.config) db.config = { theme: 'paper' };
    if (!Array.isArray(db.config.customReminders)) db.config.customReminders = [];
  }

  function renderCustomReminders() {
    ensureCustomReminders();
    const cont = document.getElementById('custom-reminders');
    if (!cont) return;

    if (!db.config.customReminders.length) {
      cont.innerHTML = '<div style="font-size:12px; opacity:0.7; margin-bottom:12px;">Nenhum lembrete extra.</div>';
      return;
    }

    cont.innerHTML = db.config.customReminders.map((r, i) => `
      <div style="display:grid; grid-template-columns: 1.4fr .8fr; gap:10px; margin-bottom:10px;">
        <div>
          <label>T√≠tulo</label>
          <input type="text" value="${(r.title||'').replace(/"/g,'&quot;')}" oninput="updateCustomReminder(${i}, 'title', this.value)" placeholder="Ex: Ler a B√≠blia">
        </div>
        <div>
          <label>Hor√°rio</label>
          <input type="time" value="${r.time || '08:00'}" oninput="updateCustomReminder(${i}, 'time', this.value)">
        </div>
        <button class="btn-outline" type="button"
          style="grid-column:1 / -1; border-color: var(--danger); color: var(--danger); padding: 10px;"
          onclick="removeCustomReminder(${i})">REMOVER</button>
      </div>
    `).join('');
  }

  function addCustomReminder() {
    ensureCustomReminders();
    db.config.customReminders.push({ title: 'Lembrete', time: '08:00' });
    saveDB();
    renderCustomReminders();
  }

  function removeCustomReminder(i) {
    ensureCustomReminders();
    db.config.customReminders.splice(i, 1);
    saveDB();
    renderCustomReminders();
  }

  function updateCustomReminder(i, field, value) {
    ensureCustomReminders();
    db.config.customReminders[i][field] = value;
    saveDB();
  }

  function savePlan() {
    const tema = document.getElementById('p-tema').value || "Meu Prop√≥sito";
    const inicioStr = document.getElementById('p-inicio').value;
    if(!inicioStr) return alert("Defina a data de in√≠cio.");

    const duracaoSel = document.getElementById('p-duracao').value;
    const duracao = duracaoSel === 'custom'
      ? parseInt(document.getElementById('p-duracao-custom').value || '0', 10)
      : parseInt(duracaoSel, 10);

    if (!duracao || duracao < 1) return alert("Informe uma dura√ß√£o v√°lida (em dias).");

    const horasSel = document.getElementById('p-horas').value;
    let horasDisplay = horasSel;

    if (horasSel === 'custom') {
      const fs = document.getElementById('p-fast-start').value;
      const fe = document.getElementById('p-fast-end').value;
      if (!fs || !fe) return alert("Defina o in√≠cio e o fim do jejum di√°rio.");
      horasDisplay = `Personalizado (${fs} √†s ${fe})`;
    } else if (horasSel === '12h') {
      horasDisplay = "12 Horas (06h √†s 18h)";
    } else if (horasSel === '18h') {
      horasDisplay = "18 Horas";
    } else if (horasSel === '24h') {
      horasDisplay = "24 Horas";
    }

    const freq = document.getElementById('p-freq').value;
    const plano = { id: Date.now(), tema, inicio: inicioStr, horas: horasDisplay, dias: [] };

    const selectedWeekdays = Array.from(document.querySelectorAll('#week-sel .check-btn.active')).map(btn => parseInt(btn.dataset.d));

    if (freq === 'semanal' && selectedWeekdays.length === 0) {
      return alert("Selecione os dias da semana desejados.");
    }

    let d = new Date(inicioStr + 'T00:00:00');
    let diasContados = 0;

    while (diasContados < duracao) {
      const diaDaSemana = d.getDay();
      if (freq === 'corrido' || selectedWeekdays.includes(diaDaSemana)) {
        plano.dias.push({ data: d.toLocaleDateString('pt-BR'), jejum: false, oracao: false, leitura: false });
        diasContados++;
      }
      d.setDate(d.getDate() + 1);
    }

    db.plans.unshift(plano); saveDB(); showView('lista');
  }

  function renderPlans() {
    const cont = document.getElementById('plans-container');
    cont.innerHTML = db.plans.length ? '' : '<p style="text-align:center; opacity:0.5; margin-top:40px;">Nenhum prop√≥sito ativo.</p>';
    db.plans.forEach(p => {
      cont.innerHTML += `<div class="card" onclick="showDetail(${p.id})">
          <div style="font-weight:800; color:var(--accent)">${p.tema}</div>
          <div style="font-size:12px; opacity:0.7">Meta: ${p.horas} | In√≠cio: ${p.inicio}</div>
        </div>`;
    });
  }

  function showDetail(id) {
    const p = db.plans.find(x => x.id === id);
    if(!p) return;
    showView('detalhe');
    document.getElementById('detail-content').innerHTML = `
      <div style="margin-bottom:15px; font-weight:800; color:var(--accent); cursor:pointer" onclick="showView('lista')">‚Üê VOLTAR AO DI√ÅRIO</div>
      <div class="card">
        <h2 style="margin-top:0">${p.tema}</h2>
        ${p.dias.map((d, i) => `
          <div class="day-row">
            <div class="day-title"><span class="day-num">${i+1}</span> ${d.data}</div>
            <div class="check-container">
              <button class="check-btn ${d.jejum?'active':''}" onclick="toggleTask(${p.id}, ${i}, 'jejum')">JEJUM</button>
              <button class="check-btn ${d.oracao?'active':''}" onclick="toggleTask(${p.id}, ${i}, 'oracao')">ORA√á√ÉO</button>
              <button class="check-btn ${d.leitura?'active':''}" onclick="toggleTask(${p.id}, ${i}, 'leitura')">LEITURA</button>
            </div>
          </div>`).join('')}
        <button onclick="deletePlan(${p.id})" style="background:none; border:none; color:var(--danger); width:100%; margin-top:30px; font-weight:800; font-size:11px; cursor:pointer">EXCLUIR PROP√ìSITO</button>
      </div>`;
  }

  function toggleTask(pid, idx, task) {
    const p = db.plans.find(x => x.id === pid);
    p.dias[idx][task] = !p.dias[idx][task];
    saveDB(); showDetail(pid);
  }

  function deletePlan(id) { if(confirm("Apagar prop√≥sito?")) { db.plans = db.plans.filter(x => x.id !== id); saveDB(); showView('lista'); } }

  function setTheme(t) {
    document.documentElement.setAttribute('data-theme', t);
    db.config.theme = t;
    saveDB();
  }

  // --- NOTIFICA√á√ïES (NATIVO ANDROID + WEB) ---
  const statusBadge = document.getElementById("notif-status");

  function setRemStatus() {
    const active = localStorage.getItem("faith_rem_active");
    statusBadge.innerText = active ? "Notifica√ß√µes Ativas" : "Notifica√ß√µes Desativadas";
    statusBadge.className = "status-badge " + (active ? "status-on" : "status-off");
  }

  // Detecta se est√° rodando no App (Capacitor) ou no navegador.
  // OBS: `Capacitor.isNative` n√£o existe nas vers√µes atuais.
  function isCapacitor() {
    return !!(
      window.Capacitor &&
      typeof window.Capacitor.getPlatform === 'function' &&
      window.Capacitor.getPlatform() !== 'web'
    );
  }

  async function scheduleAll() {
    const baseTimes = [
      { id: 1, time: document.getElementById("rem-f-start").value, title: "In√≠cio do Jejum", body: "Que Deus aben√ßoe seu prop√≥sito hoje." },
      { id: 2, time: document.getElementById("rem-f-end").value, title: "Entrega do Jejum", body: "Momento de orar e entregar seu jejum." },
      { id: 3, time: document.getElementById("rem-p-start").value, title: "Ora√ß√£o Manh√£", body: "Comece o dia na presen√ßa de Deus." },
      { id: 4, time: document.getElementById("rem-p-end").value, title: "Ora√ß√£o Noite", body: "N√£o esque√ßa de registrar seu dia no app." }
    ];

    ensureCustomReminders();

    const extraTimes = (db.config.customReminders || [])
      .filter(r => r && r.time)
      .map((r, idx) => ({
        id: 100 + idx,
        time: r.time,
        title: r.title && r.title.trim() ? r.title.trim() : "Lembrete",
        body: "Lembrete do seu prop√≥sito de jejum e ora√ß√£o."
      }));

    const times = [...baseTimes, ...extraTimes];

    if (isCapacitor()) {
      // --- L√≥gica Nativa (Android/iOS via Capacitor) ---
      try {
        const LocalNotifications = window.Capacitor?.Plugins?.LocalNotifications;
        if (!LocalNotifications) {
          alert("Plugin de notifica√ß√µes n√£o encontrado (LocalNotifications). Verifique se o plugin foi sincronizado: npx cap sync");
          return false;
        }

        // Android 13+ exige check + request de permiss√£o
        const current = await LocalNotifications.checkPermissions();
        let perm = current;
        if (current.display !== 'granted') {
          perm = await LocalNotifications.requestPermissions();
        }
        if (perm.display !== 'granted') {
          alert("Permiss√£o de notifica√ß√µes negada. Ative em Configura√ß√µes do Android > Notifica√ß√µes.");
          return false;
        }

        // Android 12+ (e principalmente Android 14+) pode exigir habilitar alarmes exatos
        // (caso o usu√°rio desative, o Android pode apagar os alarmes do app).
        try {
          const exact = await LocalNotifications.checkExactNotificationSetting();
          if (exact && exact.value === false) {
            const go = confirm(
              "Para tocar exatamente no hor√°rio, habilite 'Alarmes e lembretes' para este app.\n\nDeseja abrir os ajustes agora?"
            );
            if (go) await LocalNotifications.changeExactNotificationSetting();
          }
        } catch (_) {
          // Alguns dispositivos/vers√µes podem n√£o suportar essa checagem; segue sem bloquear.
        }

        // Limpa anteriores (base + extras)
        await LocalNotifications.cancel({ notifications: times.map(t => ({ id: t.id })) });

        // Agenda novos (Schedule.on j√° √© recorrente, estilo "cron")
        const notifs = times.map(t => {
          const [h, m] = t.time.split(":").map(Number);
          return {
            id: t.id,
            title: t.title,
            body: t.body,
            schedule: { on: { hour: h, minute: m }, allowWhileIdle: true }
          };
        });

        await LocalNotifications.schedule({ notifications: notifs });

      } catch (e) {
        alert("Erro no plugin: " + (e?.message || e));
        return false;
      }

    } else {
      // --- L√≥gica Web (Computador/Teste) ---
      if (Notification.permission !== "granted") {
        const p = await Notification.requestPermission();
        if (p !== "granted") return alert("Permita as notifica√ß√µes no navegador.");
      }
      alert("No computador, as notifica√ß√µes s√≥ funcionam com a aba aberta. No celular funcionar√£o fechadas.");
    }

    return true;
  }

  async function cancelAll() {
    if (isCapacitor()) {
      try {
        const LocalNotifications = window.Capacitor?.Plugins?.LocalNotifications;
        if (!LocalNotifications) return;

        ensureCustomReminders();
        const base = [{id:1}, {id:2}, {id:3}, {id:4}];
        const extra = (db.config.customReminders || []).map((_, idx) => ({ id: 100 + idx }));
        await LocalNotifications.cancel({ notifications: [...base, ...extra] });

      } catch(e) { console.log(e); }
    }
  }

  document.getElementById("btn-enable-notif").addEventListener("click", async () => {
    const success = await scheduleAll();
    if (success) {
      localStorage.setItem("faith_rem_active", "true");
      setRemStatus();
      alert("Notifica√ß√µes agendadas com sucesso!");
    }
  });

  document.getElementById("btn-disable-notif").addEventListener("click", async () => {
    await cancelAll();
    localStorage.removeItem("faith_rem_active");
    setRemStatus();
    alert("Todas as notifica√ß√µes foram canceladas.");
  });

  window.onload = () => {
    ensureCustomReminders();
    setTheme(db.config.theme);
    document.getElementById('cfg-theme').value = db.config.theme;
    setRemStatus();
    renderCustomReminders();

    // Garante estado inicial dos campos personalizados
    toggleDuracaoCustom(document.getElementById('p-duracao').value);
    toggleHorasCustom(document.getElementById('p-horas').value);
  };
</script>
</body>
</html>
